#!/usr/bin/env python3
import json
import sys
import requests
import argparse

FLAGS = ["secure", "httponly", "samesite"]

def run(url):
    try:
        r = requests.get(url, timeout=10, allow_redirects=True)
        cookies = r.headers.get("Set-Cookie")

        if not cookies:
            return {
                "check_name": "Cookie Security Flags",
                "target": url,
                "vulnerable": False, # ✅ تم التغيير
                "details": []
            }

        findings = []

        for c in cookies.split(","):
            missing = [f for f in FLAGS if f not in c.lower()]
            if missing:
                findings.append({
                    "cookie": c.split(";")[0].strip(),
                    "missing_flags": missing
                })

        return {
            "check_name": "Cookie Security Flags",
            "target": url,
            "vulnerable": True if findings else False, # ✅ تم التغيير
            "details": findings
        }
    except Exception as e:
        return {
            "check_name": "Cookie Security Flags",
            "target": url,
            "vulnerable": False,
            "error": str(e)
        }

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--payload", required=True)
    parser.add_argument("--outdir", required=False)
    args = parser.parse_args()

    try:
        with open(args.payload, "r") as f:
            data = json.load(f)
            url = data.get("url") or data.get("target", {}).get("url")

        if not url:
            print(json.dumps({"error": "No URL found", "vulnerable": False}))
            sys.exit(1)

        print(json.dumps(run(url), indent=2))
        
    except Exception as e:
        print(json.dumps({"error": str(e), "vulnerable": False}))