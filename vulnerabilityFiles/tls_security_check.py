#!/usr/bin/env python3
import json
import sys
import ssl
import socket
import argparse
from urllib.parse import urlparse

def run(url):
    try:
        parsed = urlparse(url)

        if parsed.scheme != "https":
            return {
                "check_name": "TLS Security",
                "target": url,
                "vulnerable": True, # ✅ تم التغيير
                "details": {
                    "https_used": False,
                    "reason": "Site is not using HTTPS"
                }
            }

        hostname = parsed.hostname
        port = 443

        context = ssl.create_default_context()
        with socket.create_connection((hostname, port), timeout=5) as sock:
            with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                tls_version = ssock.version()
                # cert = ssock.getpeercert() # يمكن استخدامها لاحقاً

        weak_versions = ["TLSv1", "TLSv1.1"]

        return {
            "check_name": "TLS Security",
            "target": url,
            "vulnerable": True if tls_version in weak_versions else False, # ✅ تم التغيير
            "details": {
                "https_used": True,
                "tls_version": tls_version,
                "certificate_present": True
            }
        }

    except Exception as e:
        return {
            "check_name": "TLS Security",
            "target": url,
            "vulnerable": True, # خطأ في الاتصال قد يعني مشكلة في الشهادة
            "details": {
                "https_used": True,
                "error": str(e)
            }
        }

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--payload", required=True)
    parser.add_argument("--outdir", required=False)
    args = parser.parse_args()

    try:
        with open(args.payload, "r") as f:
            data = json.load(f)
            url = data.get("url") or data.get("target", {}).get("url")

        if not url:
            print(json.dumps({"error": "No URL found", "vulnerable": False}))
            sys.exit(1)

        print(json.dumps(run(url), indent=2))
        
    except Exception as e:
        print(json.dumps({"error": str(e), "vulnerable": False}))